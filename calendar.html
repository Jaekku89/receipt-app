<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ïä§ÎßàÌä∏ Í∑ºÌÉú Îã¨Î†•</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 10px; background: #f0f2f5; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header h2 { margin: 0; color: #333; font-size: 22px; font-weight: 800; }
        .btn-month { background: none; border: 1px solid #ddd; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 18px; color: #555; }
        
        .calendar-grid { display: grid; grid-template-columns: 25px repeat(7, 1fr); gap: 0; border-top: 1px solid #eee; border-left: 1px solid #eee; }
        
        .header-cell { background: #f8f9fa; padding: 8px 0; font-size: 13px; font-weight: bold; border-right: 1px solid #eee; border-bottom: 1px solid #eee; color: #333; text-align: center;}
        .header-cell.sun { color: #e74c3c; } 
        .header-cell.sat { color: #2980b9; } 

        .week-label { display: flex; align-items: center; justify-content: center; font-size: 10px; color: #bbb; background: #fdfdfd; border-right: 1px solid #eee; border-bottom: 1px solid #eee; writing-mode: vertical-lr; transform: rotate(180deg); }

        .day-cell { 
            min-height: 100px; 
            border-right: 1px solid #eee; 
            border-bottom: 1px solid #eee; 
            padding: 0; 
            padding-bottom: 5px;
            font-size: 13px; 
            position: relative; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            gap: 1px; 
        }
        
        .day-cell.sat { background-color: #fafbfd; } 
        .day-cell.sat .day-num { color: #2980b9; }    
        
        .day-cell.holiday-bg { background-color: #fdfafa !important; } 
        .day-cell.holiday-bg .day-num { color: #e74c3c !important; }

        .day-cell.today { 
            background-color: #fff !important; 
            box-shadow: inset 0 0 0 2px #03c75a !important; 
            z-index: 1; 
        }
        
        .day-num { 
            display: block; 
            margin-bottom: 2px; 
            font-weight: bold; 
            color: #333; 
            text-align: left; 
            padding: 5px 0 0 5px; 
        }

        .event-bar { 
            display: block; 
            font-size: 11px; 
            color: white; 
            padding: 3px 6px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            cursor: pointer; 
            text-align: left; 
            height: 16px; 
            line-height: 16px;
            position: relative;
        }
        
        .event-bar.is-start { border-top-left-radius: 4px; border-bottom-left-radius: 4px; margin-left: 3px; }
        .event-bar.is-end { border-top-right-radius: 4px; border-bottom-right-radius: 4px; margin-right: 3px; }
        .event-bar:not(.is-start) { margin-left: -1px; padding-left: 8px; } 
        .event-bar:not(.is-end) { margin-right: -1px; padding-right: 8px; }

        .evt-trip { background: #4a90e2; } 
        .evt-vacation { background: #e74c3c; } 
        .evt-etc { background: #f5a623; }
        
        .evt-holiday { 
            background: transparent !important; 
            color: #e74c3c; 
            font-size: 11px; 
            font-weight: bold;
            text-align: left;
            margin-bottom: 2px;
            padding-left: 5px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; /* ÌÅ¥Î¶≠Ìï¥ÏÑú ÎÇ¥Ïö© ÌôïÏù∏ Í∞ÄÎä• */
        } 
        
        hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
        h3 { margin: 0 0 15px 0; color: #333; font-size: 18px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 13px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 0; font-size: 15px; box-sizing: border-box; appearance: none; }
        
        .type-group { display: flex; gap: 8px; }
        .radio-label { flex: 1; text-align: center; padding: 12px 5px; border: 1px solid #ddd; cursor: pointer; background: #fff; font-size: 13px; white-space: nowrap; }
        .radio-label input { display: none; }
        input[type="radio"]:checked + span { font-weight: bold; }
        
        .radio-label:has(input[value="Ï∂úÏû•"]:checked) { background: #eaf4ff; border-color: #4a90e2; color: #4a90e2; }
        .radio-label:has(input[value="Ïó∞Ï∞®"]:checked) { background: #ffeeee; border-color: #e74c3c; color: #e74c3c; }
        .radio-label:has(input[value="Í∏∞ÌÉÄ"]:checked) { background: #fff0f0; border-color: #c0392b; color: #c0392b; }

        .btn-submit { width: 100%; background: #03c75a; color: white; padding: 15px; border: none; border-radius: 0; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; color: white; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader" class="loader">Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë...</div>

<div class="container">
    <div class="calendar-header">
        <button class="btn-month" onclick="changeMonth(-1)">‚óÄ</button>
        <h2 id="monthTitle"></h2>
        <button class="btn-month" onclick="changeMonth(1)">‚ñ∂</button>
    </div>
    
    <div class="calendar-grid" id="calendar"></div>

    <hr>

    <h3>üìù ÏùºÏ†ï Îì±Î°ù</h3>
    <div class="form-group">
        <label>ÏßÅÏõê Ïù¥Î¶Ñ</label>
        <input type="text" id="name" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•">
    </div>

    <div class="form-group">
        <label>Íµ¨Î∂Ñ</label>
        <div class="type-group">
            <label class="radio-label"><input type="radio" name="type" value="Ï∂úÏû•" checked><span>‚úàÔ∏è Ï∂úÏû•</span></label>
            <label class="radio-label"><input type="radio" name="type" value="Ïó∞Ï∞®"><span>üèñÔ∏è Ïó∞Ï∞®</span></label>
            <label class="radio-label"><input type="radio" name="type" value="Í∏∞ÌÉÄ"><span>üìù Í∏∞ÌÉÄ</span></label>
            </div>
    </div>

    <div class="form-group"><label>ÏãúÏûëÏùº</label><input type="date" id="startDate"></div>
    <div class="form-group"><label>Ï¢ÖÎ£åÏùº</label><input type="date" id="endDate"></div>
    <div class="form-group"><label>ÏÉÅÏÑ∏ ÎÇ¥Ïö© (Î™©Ï†ÅÏßÄ Îì±)</label><input type="text" id="reason" placeholder="Ïòà: Î∂ÄÏÇ∞ Ï∂úÏû• / Í∞úÏù∏ ÏÇ¨Ï†ï"></div>

    <button class="btn-submit" onclick="submitData()">Îì±Î°ùÌïòÍ∏∞</button>
</div>

<script>
    // ‚òÖ‚òÖ‚òÖ [Ï§ëÏöî] Î∞∞Ìè¨ URL ÏûÖÎ†• ‚òÖ‚òÖ‚òÖ
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxj1RhofZM8Kat7VUk-MZ9oNCgiTMn_Mi3inSWFDy-hbB1oDOCl4IpZGlcNH_gDxylQig/exec";

    // Í∏∞Î≥∏ Í≥µÌú¥Ïùº Îç∞Ïù¥ÌÑ∞ (ÌëúÏãúÏö©)
    const DEFAULT_HOLIDAYS = {
        "2025-01-01": "Ïã†Ï†ï", "2025-01-27": "ÎåÄÏ≤¥Ìú¥Ïùº", "2025-01-28": "ÏÑ§ÎÇ†", "2025-01-29": "ÏÑ§ÎÇ† Ïó∞Ìú¥", "2025-01-30": "ÏÑ§ÎÇ† Ïó∞Ìú¥",
        "2025-03-01": "ÏÇºÏùºÏ†à", "2025-03-03": "ÎåÄÏ≤¥Ìú¥Ïùº", "2025-05-05": "Ïñ¥Î¶∞Ïù¥ÎÇ†", "2025-05-06": "ÎåÄÏ≤¥Ìú¥Ïùº", "2025-06-06": "ÌòÑÏ∂©Ïùº",
        "2025-08-15": "Í¥ëÎ≥µÏ†à", "2025-10-03": "Í∞úÏ≤úÏ†à", "2025-10-05": "Ï∂îÏÑù Ïó∞Ìú¥", "2025-10-06": "Ï∂îÏÑù", "2025-10-07": "Ï∂îÏÑù Ïó∞Ìú¥",
        "2025-10-08": "ÎåÄÏ≤¥Ìú¥Ïùº", "2025-10-09": "ÌïúÍ∏ÄÎÇ†", "2025-12-25": "ÏÑ±ÌÉÑÏ†à",
        "2026-01-01": "Ïã†Ï†ï", "2026-02-16": "ÏÑ§ÎÇ† Ïó∞Ìú¥", "2026-02-17": "ÏÑ§ÎÇ†", "2026-02-18": "ÏÑ§ÎÇ† Ïó∞Ìú¥", "2026-03-01": "ÏÇºÏùºÏ†à",
        "2026-03-02": "ÎåÄÏ≤¥Ìú¥Ïùº", "2026-05-05": "Ïñ¥Î¶∞Ïù¥ÎÇ†", "2026-05-24": "Î∂ÄÏ≤òÎãòÏò§Ïã†ÎÇ†", "2026-05-25": "ÎåÄÏ≤¥Ìú¥Ïùº", "2026-06-03": "ÏßÄÎ∞©ÏÑ†Í±∞",
        "2026-06-06": "ÌòÑÏ∂©Ïùº", "2026-08-15": "Í¥ëÎ≥µÏ†à", "2026-08-17": "ÎåÄÏ≤¥Ìú¥Ïùº", "2026-09-24": "Ï∂îÏÑù Ïó∞Ìú¥", "2026-09-25": "Ï∂îÏÑù",
        "2026-09-26": "Ï∂îÏÑù Ïó∞Ìú¥", "2026-10-03": "Í∞úÏ≤úÏ†à", "2026-10-09": "ÌïúÍ∏ÄÎÇ†", "2026-12-25": "ÏÑ±ÌÉÑÏ†à"
    };

    let HOLIDAYS = DEFAULT_HOLIDAYS; 
    let currentDate = new Date(); 
    let dbEvents = []; 

    window.onload = function() {
        if(SCRIPT_URL.includes("Ïó¨Í∏∞Ïóê")) { alert("URL ÎØ∏ÏÑ§Ï†ï"); return; }
        document.getElementById('startDate').valueAsDate = new Date();
        document.getElementById('endDate').valueAsDate = new Date();
        loadEvents(); 
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    function loadEvents() {
        showLoader(true);
        fetch(SCRIPT_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            dbEvents = data.events;
            // Í¥ÄÎ¶¨ÏûêÍ∞Ä PCÏóêÏÑú ÏàòÏ†ïÌïú Í≥µÌú¥Ïùº Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏïÑÏôÄÏÑú Ï†ÅÏö© (Î≥¥Í∏∞Îßå Í∞ÄÎä•)
            if(data.holidays && data.holidays.length > 10) {
                try { HOLIDAYS = JSON.parse(data.holidays); } catch(e) { HOLIDAYS = DEFAULT_HOLIDAYS; }
            }
            renderCalendar(); 
            showLoader(false);
        })
        .catch(err => { alert("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®"); showLoader(false); });
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        document.getElementById('monthTitle').innerText = `${year}.${String(month+1).padStart(2,'0')}`;
        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = '';

        calendarEl.innerHTML += `<div class="week-label"></div>`; 
        const days = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
        days.forEach((d, idx) => {
            let className = 'header-cell';
            if(idx === 0) className += ' sun'; 
            if(idx === 6) className += ' sat'; 
            calendarEl.innerHTML += `<div class="${className}">${d}</div>`;
        });

        const firstDayObj = new Date(year, month, 1);
        const firstDay = firstDayObj.getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        let currentDay = 1;
        let weekCount = 0;
        
        while(currentDay <= lastDate) {
            let weekStartObj = new Date(year, month, currentDay);
            let weekNum = getWeekNumber(weekStartObj);
            
            calendarEl.innerHTML += `<div class="week-label">WK${weekNum}</div>`;

            for(let i=0; i<7; i++) {
                if(weekCount === 0 && i < firstDay) {
                    calendarEl.innerHTML += `<div style="border-bottom:1px solid #eee; border-right:1px solid #eee; background:#fafafa;"></div>`;
                } 
                else if(currentDay <= lastDate) {
                    let isToday = (year === new Date().getFullYear() && month === new Date().getMonth() && currentDay === new Date().getDate()) ? 'today' : '';
                    let thisDayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(currentDay).padStart(2,'0')}`;
                    
                    let holidayName = HOLIDAYS[thisDayStr];
                    let isRedDay = (i === 0 || holidayName) ? true : false;

                    let bgClass = '';
                    if(isRedDay) bgClass = 'holiday-bg';
                    else if(i === 6) bgClass = 'sat'; 

                    dbEvents.forEach(evt => {
                         if(evt.type === 'Ìú¥Î¨¥' && thisDayStr >= evt.start && thisDayStr <= evt.end) {
                             bgClass = 'holiday-bg';
                             isRedDay = true;
                         }
                    });

                    let cellHtml = `<div class="day-cell ${bgClass} ${isToday}">`;
                    
                    let numColor = '';
                    if(isRedDay) numColor = 'style="color:#e74c3c"';
                    else if(i === 6) numColor = 'style="color:#2980b9"';

                    cellHtml += `<span class="day-num" ${numColor}>${currentDay}</span>`;
                    
                    if(holidayName) {
                        cellHtml += `<div class="evt-holiday">${holidayName}</div>`;
                    }

                    // ÏùºÏ†ï Ï†ïÎ†¨
                    let todaysEvents = dbEvents.filter(evt => thisDayStr >= evt.start && thisDayStr <= evt.end);
                    todaysEvents.sort((a,b) => a.id.localeCompare(b.id));

                    todaysEvents.forEach(evt => {
                        if(evt.type === 'Ìú¥Î¨¥') {
                            cellHtml += `<div class="evt-holiday">${evt.reason}</div>`;
                        } else {
                            let colorClass = evt.type === 'Ï∂úÏû•' ? 'evt-trip' : (evt.type === 'Ïó∞Ï∞®' ? 'evt-vacation' : 'evt-etc');
                            let displayText = evt.name;
                            if (evt.type === 'Ïó∞Ï∞®') displayText += " - Ïó∞Ï∞®";
                            else if(evt.reason) displayText += " - " + evt.reason;

                            let isStart = (thisDayStr === evt.start);
                            let isWeekStart = (i === 0);
                            let showText = isStart || isWeekStart;
                            let content = showText ? displayText : "&nbsp;"; 

                            let barClass = "";
                            if(isStart) barClass += " is-start";
                            if(thisDayStr === evt.end) barClass += " is-end";

                            cellHtml += `<span class="event-bar ${colorClass} ${barClass}" onclick="askDelete('${evt.id}', '${evt.name}', '${evt.type}')">${content}</span>`;
                        }
                    });

                    cellHtml += `</div>`;
                    calendarEl.innerHTML += cellHtml;
                    currentDay++;
                } 
                else {
                    calendarEl.innerHTML += `<div style="border-bottom:1px solid #eee; border-right:1px solid #eee; background:#fafafa;"></div>`;
                }
            }
            weekCount++;
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    function askDelete(id, name, type) {
        if(!id || id.startsWith('manual_') === false) return; 
        if(confirm(`[${type}] ${name} ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            showLoader(true);
            fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", id: id }) })
            .then(() => { alert("üóëÔ∏è ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."); setTimeout(loadEvents, 1000); })
            .catch(err => { alert("Ïò§Î•ò"); showLoader(false); });
        }
    }

    function submitData() {
        const name = document.getElementById('name').value;
        const type = document.querySelector('input[name="type"]:checked').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const reason = document.getElementById('reason').value;

        // ‚òÖ‚òÖ‚òÖ [ÏàòÏ†ï] Ìú¥Î¨¥ Î≤ÑÌäºÏù¥ ÏóÜÏúºÎØÄÎ°ú Ïù¥Î¶Ñ ÏûÖÎ†• ÌïÑÏàò ‚òÖ‚òÖ‚òÖ
        if(!name) { alert("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return; }
        if(!startDate || !endDate) { alert("ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return; }
        if(!reason) { alert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return; }

        showLoader(true);
        const data = { name, type, startDate, endDate, reason };
        fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) })
        .then(() => { alert("‚úÖ Îì±Î°ùÎê®"); document.getElementById('name').value=''; document.getElementById('reason').value=''; loadEvents(); })
        .catch(err => { alert("Ïò§Î•ò"); showLoader(false); });
    }
</script>

</body>
</html>
