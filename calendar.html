<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ ê·¼íƒœ ë‹¬ë ¥</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 5px; background: #f0f2f5; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-header h2 { margin: 0; color: #333; font-size: 20px; font-weight: 800; }
        .btn-month { background: none; border: 1px solid #ddd; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 16px; color: #555; }
        
        .calendar-grid { display: grid; grid-template-columns: 20px repeat(7, 1fr); gap: 0; border-top: 1px solid #eee; border-left: 1px solid #eee; }
        
        .header-cell { background: #f8f9fa; padding: 6px 0; font-size: 11px; font-weight: bold; border-right: 1px solid #eee; border-bottom: 1px solid #eee; color: #333; text-align: center;}
        .header-cell.sun { color: #e74c3c; } 
        .header-cell.sat { color: #2980b9; } 

        .week-label { display: flex; align-items: center; justify-content: center; font-size: 9px; color: #bbb; background: #fdfdfd; border-right: 1px solid #eee; border-bottom: 1px solid #eee; writing-mode: vertical-lr; transform: rotate(180deg); }

        .day-cell { 
            min-height: 70px; 
            border-right: 1px solid #eee; 
            border-bottom: 1px solid #eee; 
            padding: 0; 
            padding-bottom: 3px;
            font-size: 11px; 
            position: relative; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            gap: 1px; 
        }
        
        .day-cell.sat { background-color: #fafbfd; } 
        .day-cell.sat .day-num { color: #2980b9; }    
        .day-cell.holiday-bg { background-color: #fdfafa !important; } 
        .day-cell.holiday-bg .day-num { color: #e74c3c !important; }
        .day-cell.today { background-color: #fff !important; box-shadow: inset 0 0 0 1px #03c75a !important; z-index: 1; }
        
        .day-num { display: block; margin-bottom: 1px; font-weight: bold; color: #333; text-align: left; padding: 3px 0 0 3px; font-size: 11px; }

        /* â˜…â˜…â˜… [í•µì‹¬ ìˆ˜ì •] ê¸€ì”¨ê°€ ì¹¸ì„ ë„˜ì–´ê°€ë„ë¡ ì„¤ì • â˜…â˜…â˜… */
        .event-bar { 
            display: block; 
            height: 14px; 
            line-height: 14px;
            position: relative;
            margin-bottom: 1px;
            cursor: pointer;
            /* overflow: hiddenì„ ì œê±°í•˜ì—¬ ê¸€ì”¨ê°€ ë°–ìœ¼ë¡œ ë‚˜ê°€ê²Œ í•¨ */
        }
        
        /* í…ìŠ¤íŠ¸ ë˜í¼: ì ˆëŒ€ ìœ„ì¹˜ë¡œ ë„ì›Œì„œ ì¹¸ ë„ˆë¹„ ë¬´ì‹œ */
        .evt-content {
            position: absolute;
            left: 4px;
            top: 0;
            white-space: nowrap;
            font-size: 9px;
            color: white;
            z-index: 10; /* ê¸€ì”¨ê°€ ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ëœ¨ë„ë¡ */
            pointer-events: none; /* í´ë¦­ì€ ë’¤ìª½ ë°”ê°€ ë°›ë„ë¡ */
            text-shadow: 0 0 2px rgba(0,0,0,0.2); /* ê°€ë…ì„± ìœ„í•´ ê·¸ë¦¼ì ì‚´ì§ */
        }

        .event-bar.is-start { border-top-left-radius: 3px; border-bottom-left-radius: 3px; margin-left: 2px; }
        .event-bar.is-end { border-top-right-radius: 3px; border-bottom-right-radius: 3px; margin-right: 2px; }
        .event-bar:not(.is-start) { margin-left: -1px; } 
        .event-bar:not(.is-end) { margin-right: -1px; }

        .evt-trip { background: #4a90e2; } 
        .evt-vacation { background: #e74c3c; } 
        .evt-etc { background: #f5a623; }
        
        .evt-holiday { 
            background: transparent !important; 
            color: #e74c3c; 
            font-size: 9px; 
            font-weight: bold;
            text-align: left;
            margin-bottom: 1px;
            padding-left: 3px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer;
        } 
        
        hr { border: 0; border-top: 1px solid #eee; margin: 15px 0; }
        h3 { margin: 0 0 10px 0; color: #333; font-size: 16px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 3px; font-weight: bold; color: #555; font-size: 12px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 0; font-size: 14px; box-sizing: border-box; appearance: none; }
        
        .type-group { display: flex; gap: 5px; }
        .radio-label { flex: 1; text-align: center; padding: 10px 2px; border: 1px solid #ddd; cursor: pointer; background: #fff; font-size: 12px; white-space: nowrap; }
        .radio-label input { display: none; }
        input[type="radio"]:checked + span { font-weight: bold; }
        
        .radio-label:has(input[value="ì¶œì¥"]:checked) { background: #eaf4ff; border-color: #4a90e2; color: #4a90e2; }
        .radio-label:has(input[value="ì—°ì°¨"]:checked) { background: #ffeeee; border-color: #e74c3c; color: #e74c3c; }
        .radio-label:has(input[value="ê¸°íƒ€"]:checked) { background: #fff0f0; border-color: #c0392b; color: #c0392b; }

        .btn-submit { width: 100%; background: #03c75a; color: white; padding: 12px; border: none; border-radius: 0; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        
        .loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; color: white; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader" class="loader">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>

<div class="container">
    <div class="calendar-header">
        <button class="btn-month" onclick="changeMonth(-1)">â—€</button>
        <h2 id="monthTitle"></h2>
        <button class="btn-month" onclick="changeMonth(1)">â–¶</button>
    </div>
    
    <div class="calendar-grid" id="calendar"></div>

    <hr>

    <h3>ğŸ“ ì¼ì • ë“±ë¡</h3>
    <div class="form-group">
        <label>ì§ì› ì´ë¦„</label>
        <input type="text" id="name" placeholder="ì´ë¦„ ì…ë ¥">
    </div>

    <div class="form-group">
        <label>êµ¬ë¶„</label>
        <div class="type-group">
            <label class="radio-label"><input type="radio" name="type" value="ì¶œì¥" checked><span>âœˆï¸ ì¶œì¥</span></label>
            <label class="radio-label"><input type="radio" name="type" value="ì—°ì°¨"><span>ğŸ–ï¸ ì—°ì°¨</span></label>
            <label class="radio-label"><input type="radio" name="type" value="ê¸°íƒ€"><span>ğŸ“ ê¸°íƒ€</span></label>
        </div>
    </div>

    <div class="form-group"><label>ì‹œì‘ì¼</label><input type="date" id="startDate"></div>
    <div class="form-group"><label>ì¢…ë£Œì¼</label><input type="date" id="endDate"></div>
    <div class="form-group"><label>ìƒì„¸ ë‚´ìš©</label><input type="text" id="reason" placeholder="ëª©ì ì§€ / ì‚¬ìœ "></div>

    <button class="btn-submit" onclick="submitData()">ë“±ë¡í•˜ê¸°</button>
</div>

<script>
    // â˜…â˜…â˜… [ì¤‘ìš”] ë°°í¬ URL ì…ë ¥ â˜…â˜…â˜…
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxj1RhofZM8Kat7VUk-MZ9oNCgiTMn_Mi3inSWFDy-hbB1oDOCl4IpZGlcNH_gDxylQig/exec";
    const ADMIN_PASSWORD = "1234"; 

    // ê³µíœ´ì¼ ëª©ë¡
    const DEFAULT_HOLIDAYS = {
        "2025-01-01": "ì‹ ì •", "2025-01-27": "ëŒ€ì²´íœ´ì¼", "2025-01-28": "ì„¤ë‚ ", "2025-01-29": "ì„¤ë‚  ì—°íœ´", "2025-01-30": "ì„¤ë‚  ì—°íœ´",
        "2025-03-01": "ì‚¼ì¼ì ˆ", "2025-03-03": "ëŒ€ì²´íœ´ì¼", "2025-05-05": "ì–´ë¦°ì´ë‚ ", "2025-05-06": "ëŒ€ì²´íœ´ì¼", "2025-06-06": "í˜„ì¶©ì¼",
        "2025-08-15": "ê´‘ë³µì ˆ", "2025-10-03": "ê°œì²œì ˆ", "2025-10-05": "ì¶”ì„ ì—°íœ´", "2025-10-06": "ì¶”ì„", "2025-10-07": "ì¶”ì„ ì—°íœ´",
        "2025-10-08": "ëŒ€ì²´íœ´ì¼", "2025-10-09": "í•œê¸€ë‚ ", "2025-12-25": "ì„±íƒ„ì ˆ",
        "2026-01-01": "ì‹ ì •", "2026-02-16": "ì„¤ë‚  ì—°íœ´", "2026-02-17": "ì„¤ë‚ ", "2026-02-18": "ì„¤ë‚  ì—°íœ´", "2026-03-01": "ì‚¼ì¼ì ˆ",
        "2026-03-02": "ëŒ€ì²´íœ´ì¼", "2026-05-05": "ì–´ë¦°ì´ë‚ ", "2026-05-24": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2026-05-25": "ëŒ€ì²´íœ´ì¼", "2026-06-03": "ì§€ë°©ì„ ê±°",
        "2026-06-06": "í˜„ì¶©ì¼", "2026-08-15": "ê´‘ë³µì ˆ", "2026-08-17": "ëŒ€ì²´íœ´ì¼", "2026-09-24": "ì¶”ì„ ì—°íœ´", "2026-09-25": "ì¶”ì„",
        "2026-09-26": "ì¶”ì„ ì—°íœ´", "2026-10-03": "ê°œì²œì ˆ", "2026-10-09": "í•œê¸€ë‚ ", "2026-12-25": "ì„±íƒ„ì ˆ"
    };

    let HOLIDAYS = DEFAULT_HOLIDAYS; 
    let currentDate = new Date(); 
    let dbEvents = []; 

    window.onload = function() {
        document.getElementById('startDate').valueAsDate = new Date();
        document.getElementById('endDate').valueAsDate = new Date();
        loadEvents(); 
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    function loadEvents() {
        showLoader(true);
        fetch(SCRIPT_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            dbEvents = data.events;
            if(data.holidays && data.holidays.length > 10) { try { HOLIDAYS = JSON.parse(data.holidays); } catch(e) { HOLIDAYS = DEFAULT_HOLIDAYS; } }
            renderCalendar(); 
            showLoader(false);
        })
        .catch(err => { alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); showLoader(false); });
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('monthTitle').innerText = `${year}.${String(month+1).padStart(2,'0')}`;
        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = `<div class="week-label"></div>`; 
        
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((d, idx) => {
            let className = 'header-cell'; if(idx === 0) className += ' sun'; if(idx === 6) className += ' sat'; 
            calendarEl.innerHTML += `<div class="${className}">${d}</div>`;
        });

        const firstDayObj = new Date(year, month, 1);
        const firstDay = firstDayObj.getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        let currentDay = 1;
        let weekCount = 0;
        
        while(currentDay <= lastDate) {
            let weekStartObj = new Date(year, month, currentDay);
            let weekNum = getWeekNumber(weekStartObj);
            calendarEl.innerHTML += `<div class="week-label">WK${weekNum}</div>`;

            for(let i=0; i<7; i++) {
                if(currentDay <= lastDate && (currentDay > 1 || i >= firstDay)) {
                    let isToday = (year === new Date().getFullYear() && month === new Date().getMonth() && currentDay === new Date().getDate()) ? 'today' : '';
                    let thisDayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(currentDay).padStart(2,'0')}`;
                    let holidayName = HOLIDAYS[thisDayStr];
                    let isRedDay = (i === 0 || holidayName) ? true : false;
                    let bgClass = ''; 
                    let numColor = '';

                    dbEvents.forEach(evt => { if(evt.type === 'íœ´ë¬´' && thisDayStr >= evt.start && thisDayStr <= evt.end) { bgClass = 'holiday-bg'; isRedDay = true; } });
                    
                    if(isRedDay) { bgClass = 'holiday-bg'; numColor = 'style="color:#e74c3c"'; }
                    else if(i === 6) { numColor = 'style="color:#2980b9"'; bgClass = 'sat'; }

                    let cellHtml = `<div class="day-cell ${bgClass} ${isToday}">`;
                    cellHtml += `<span class="day-num" ${numColor}>${currentDay}</span>`;
                    
                    if(holidayName) cellHtml += `<div class="evt-holiday">${holidayName}</div>`;

                    // ì¼ì • ë Œë”ë§
                    let todaysEvents = dbEvents.filter(evt => thisDayStr >= evt.start && thisDayStr <= evt.end);
                    
                    // â˜…â˜…â˜… [ê¸´ ì¼ì • ìš°ì„  ì •ë ¬] â˜…â˜…â˜…
                    todaysEvents.sort((a, b) => {
                        if (a.start !== b.start) return a.start.localeCompare(b.start);
                        if (a.end !== b.end) return b.end.localeCompare(a.end); // ì¢…ë£Œì¼ ëŠ¦ì€ê²Œ ìœ„ë¡œ
                        return a.name.localeCompare(b.name);
                    });

                    todaysEvents.forEach(evt => {
                        if(evt.type === 'íœ´ë¬´') {
                            cellHtml += `<div class="evt-holiday">${evt.reason}</div>`;
                        } else {
                            let colorClass = evt.type === 'ì¶œì¥' ? 'evt-trip' : (evt.type === 'ì—°ì°¨' ? 'evt-vacation' : 'evt-etc');
                            let displayText = evt.name;
                            if (evt.type === 'ì—°ì°¨') displayText += " - ì—°ì°¨";
                            else if(evt.reason) displayText += " - " + evt.reason;

                            // â˜…â˜…â˜… [í•µì‹¬] í…ìŠ¤íŠ¸ íë¦„ ë¡œì§ â˜…â˜…â˜…
                            // ì¼ì •ì´ ì‹œì‘í•˜ëŠ” ë‚ ì´ê±°ë‚˜, ì¼ìš”ì¼(ìƒˆ ì¤„ì˜ ì‹œì‘)ì´ë©´ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œ
                            let isStart = (thisDayStr === evt.start);
                            let isWeekStart = (i === 0);
                            let showText = isStart || isWeekStart;

                            let contentHtml = "";
                            if(showText) {
                                // ê¸€ì”¨ë¥¼ absoluteë¡œ ë„ì›Œì„œ ì¹¸ ë„ˆë¹„ ì œí•œì„ ë¬´ì‹œí•˜ê³  ì˜†ìœ¼ë¡œ íë¥´ê²Œ í•¨
                                contentHtml = `<span class="evt-content">${displayText}</span>`;
                            }

                            let barClass = "";
                            if(isStart) barClass += " is-start";
                            if(thisDayStr === evt.end) barClass += " is-end";

                            cellHtml += `<div class="event-bar ${colorClass} ${barClass}" onclick="askDelete('${evt.id}', '${evt.name}', '${evt.type}', '${evt.end}')">
                                            ${contentHtml}
                                         </div>`;
                        }
                    });

                    cellHtml += `</div>`;
                    calendarEl.innerHTML += cellHtml;
                    currentDay++;
                } else {
                    calendarEl.innerHTML += `<div style="border-bottom:1px solid #eee; border-right:1px solid #eee; background:#fafafa;"></div>`;
                }
            }
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    function askDelete(id, name, type, endDateStr) {
        if(!id || id.startsWith('manual_') === false) return; 
        
        let today = new Date(); today.setHours(0,0,0,0);
        let eventEndDate = new Date(endDateStr);
        if (eventEndDate < today) {
            let inputPwd = prompt(`â›” ì§€ë‚œ ì¼ì •(${endDateStr})ì…ë‹ˆë‹¤.\nì‚­ì œí•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            if (inputPwd !== ADMIN_PASSWORD) { alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
        }
        
        if(confirm(`[${type}] ${name} ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            showLoader(true);
            fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", id: id }) })
            .then(() => { alert("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); setTimeout(loadEvents, 1000); })
            .catch(err => { alert("ì˜¤ë¥˜"); showLoader(false); });
        }
    }

    function submitData() {
        const name = document.getElementById('name').value;
        const type = document.querySelector('input[name="type"]:checked').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const reason = document.getElementById('reason').value;

        if(type !== 'íœ´ë¬´' && !name) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        if(!startDate || !endDate) { alert("ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
        if(!reason) { alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

        showLoader(true);
        const data = { name, type, startDate, endDate, reason };
        fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) })
        .then(() => { alert("âœ… ë“±ë¡ë¨"); document.getElementById('name').value=''; document.getElementById('reason').value=''; loadEvents(); })
        .catch(err => { alert("ì˜¤ë¥˜"); showLoader(false); });
    }
</script>

</body>
</html>
