<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">
    <title>ë§¤ì…ë§¤ì¶œ ê´€ë¦¬ (ì¹´ë©”ë¼ ìˆ˜ì •)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        :root { --primary: #2c3e50; --blue: #2980b9; --red: #c0392b; --orange: #d35400; --light: #f4f6f8; --border: #dfe6e9; --green: #27ae60; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; padding: 15px; background: var(--light); font-size: 14px; color: #333; -webkit-tap-highlight-color: transparent; }
        
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        .header h1 { font-size: 20px; margin: 0; color: var(--primary); }
        
        .btn { border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; padding: 10px 15px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-refresh { background: var(--green); color: white; }
        
        .input-section { background: #fafbfc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-title { font-weight: bold; font-size: 16px; color: var(--primary); }
        .btn-cancel { background: #95a5a6; color: white; font-size: 12px; display: none; padding: 6px 10px; }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full-width { grid-column: span 2; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; }
        .form-control { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; width: 100%; box-sizing: border-box; background: white; }
        .form-control:focus { border-color: var(--primary); outline: none; }

        .btn-submit { background: var(--primary); color: white; font-size: 16px; padding: 15px; margin-top: 10px; }
        .btn-submit.editing { background: #e67e22; }
        
        /* â˜…â˜…â˜… ì¹´ë©”ë¼ ë²„íŠ¼ ë¶„ë¦¬ ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
        .camera-wrapper { margin-top: 5px; }
        .camera-buttons { display: flex; gap: 10px; }
        .btn-cam-action { flex: 1; padding: 12px; border: 2px dashed #bdc3c7; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; color: var(--primary); background: #ecf0f1; }
        .btn-cam-action.active { background: #e8f8f5; border-color: var(--green); color: var(--green); }
        
        #preview-area { display: none; text-align: center; margin-top: 10px; position: relative; background: #eee; border-radius: 8px; padding: 5px; }
        #preview-img { max-height: 200px; max-width: 100%; border-radius: 4px; }
        .btn-del-img { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 25px; height: 25px; border: none; cursor: pointer; }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8f9fa; text-align: left; padding: 10px; font-size: 13px; color: #555; white-space: nowrap; border-bottom: 2px solid #eee; }
        td { border-bottom: 1px solid #eee; padding: 12px 10px; font-size: 14px; vertical-align: middle; }
        
        .col-sales { color: var(--blue); font-weight: bold; }
        .col-exp { color: var(--red); font-weight: bold; }
        .receipt-btn { background: #3498db; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; text-decoration: none; display: inline-block; }
        
        .actions { white-space: nowrap; }
        .btn-edit { background: #f39c12; color: white; padding: 5px 8px; font-size: 12px; margin-right: 5px; }
        .btn-del { background: #e74c3c; color: white; padding: 5px 8px; font-size: 12px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            th, td { padding: 10px 5px; font-size: 13px; }
        }

        .loader-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid var(--blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; flex-direction: column; }
        .modal-content { max-width: 95%; max-height: 80%; object-fit: contain; }
        .close-modal { position: absolute; top: 30px; right: 20px; color: white; font-size: 35px; font-weight: bold; cursor: pointer; padding: 20px; }
    </style>
</head>
<body>

<div id="loader" class="loader-overlay"><div class="spinner"></div><div>ì²˜ë¦¬ ì¤‘...</div></div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ë§¤ì…ë§¤ì¶œ ê´€ë¦¬</h1>
        <button class="btn btn-refresh" onclick="loadData()">ğŸ”„</button>
    </div>

    <div class="input-section">
        <div class="form-header">
            <span class="form-title" id="formTitle">ğŸ“ ì‹ ê·œ ë“±ë¡</span>
            <button class="btn btn-cancel" id="btnCancel" onclick="cancelEdit()">ì·¨ì†Œ</button>
        </div>
        
        <div class="input-grid">
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="date" class="form-control"></div>
            <div class="form-group"><label>êµ¬ë¶„</label><select id="moneyType" class="form-control"><option value="variable">ì§€ì¶œë§¤ì… (-)</option><option value="sales">ë§¤ì¶œ (+)</option><option value="fixed">ê³ ì •ë§¤ì… (-)</option></select></div>
            
            <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="tel" id="amount" placeholder="0" class="form-control"></div>
            <div class="form-group"><label>ì‚¬ìš©ì</label><input type="text" id="user" placeholder="ì´ë¦„" class="form-control"></div>
            
            <div class="form-group full-width"><label>ë‚´ì—­ (ì•„ì´í…œ)</label><input type="text" id="item" placeholder="ì˜ˆ: ì ì‹¬ì‹ì‚¬, ìì¬êµ¬ì…" class="form-control"></div>
            <div class="form-group"><label>ê³ ê°ì‚¬</label><input type="text" id="client" placeholder="ê±°ë˜ì²˜ëª…" class="form-control"></div>
            <div class="form-group"><label>ì¥ì†Œ</label><input type="text" id="location" placeholder="ì‚¬ìš© ì¥ì†Œ" class="form-control"></div>
            <div class="form-group"><label>í˜•íƒœ</label><select id="payType" class="form-control"><option value="ì¹´ë“œì˜ìˆ˜ì¦">ì¹´ë“œì˜ìˆ˜ì¦</option><option value="ê³„ì‚°ì„œë°œí–‰">ê³„ì‚°ì„œë°œí–‰</option><option value="ì†¡ê¸ˆ">ì†¡ê¸ˆ</option><option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option></select></div>
            <div class="form-group"><label>ì¹´ë“œë²ˆí˜¸</label><input type="text" id="cardNo" placeholder="ë²ˆí˜¸ (4ìë¦¬)" class="form-control"></div>
            <div class="form-group full-width"><label>ìƒì„¸ì„¤ëª…</label><input type="text" id="detail" placeholder="ì¶”ê°€ ì„¤ëª… (ì„ íƒ)" class="form-control"></div>

            <div class="camera-wrapper full-width">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this)">
                <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleFile(this)">

                <div class="camera-buttons" id="btnArea">
                    <button class="btn-cam-action" id="btnCam" onclick="document.getElementById('cameraInput').click()">ğŸ“· ë°”ë¡œ ì´¬ì˜</button>
                    
                    <button class="btn-cam-action" id="btnGal" onclick="document.getElementById('galleryInput').click()" style="background:#fff3cd; color:#d35400; border-color:#f1c40f;">ğŸ“‚ ì•¨ë²” ì„ íƒ</button>
                </div>

                <div id="preview-area" style="display:none; text-align:center; margin-top:10px; position:relative;">
                    <img id="preview-img" src="" style="max-width:100%; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                    <button class="btn-del-img" onclick="clearImg()" style="position:absolute; top:5px; right:5px; background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; font-weight:bold; cursor:pointer;">Ã—</button>
                    <div style="margin-top:5px; color:green; font-weight:bold;">âœ… ì‚¬ì§„ ì¤€ë¹„ ì™„ë£Œ</div>
                </div>
            </div>

            <button class="btn btn-submit full-width" id="btnSubmit" onclick="submitData()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ë‚´ì—­</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ê³ ê°ì‚¬</th>
                    <th>ì˜ìˆ˜ì¦</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="imageModal" class="modal" onclick="this.style.display='none'">
    <div class="close-modal">&times;</div>
    <img class="modal-content" id="modalImg">
</div>

<script>
    // â˜…â˜…â˜… [ì¤‘ìš”] ì—¬ê¸°ì— ê¸°ì¡´ êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸ URLì„ ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…
    const SERVER_URL = "https://script.google.com/macros/s/AKfycbxAbo6PtrKdVUVY5Vy9hEtC7d5U51kYchvGesrq7OkxKe84JmQxeTESh84UITFFOI_x/exec";

    let db = [];
    let currentImgBase64 = null;
    let isEditing = false;
    let editId = null;

    window.onload = function() {
        document.getElementById('date').valueAsDate = new Date();
        loadData();
    };

    function loadData() {
        if(SERVER_URL.includes("ì—¬ê¸°ì—")) { alert("https://script.google.com/macros/s/AKfycbxAbo6PtrKdVUVY5Vy9hEtC7d5U51kYchvGesrq7OkxKe84JmQxeTESh84UITFFOI_x/exec"); return; }
        showLoader(true);
        fetch(SERVER_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            db = data;
            db.sort((a,b) => new Date(b.ë‚ ì§œ) - new Date(a.ë‚ ì§œ));
            renderTable();
            showLoader(false);
        })
        .catch(err => { alert("ë¡œë“œ ì‹¤íŒ¨: " + err); showLoader(false); });
    }

    function getSafeDate(dateStr) {
        if(!dateStr) return { full: "", short: "" };
        const d = new Date(dateStr);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return { full: `${year}-${month}-${day}`, short: `${month}-${day}` };
    }

    function submitData() {
        const date = document.getElementById('date').value;
        const amount = document.getElementById('amount').value;
        const item = document.getElementById('item').value;

        if(!date || !amount || !item) { alert("ë‚ ì§œ, ê¸ˆì•¡, ë‚´ì—­ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

        const entry = {
            id: isEditing ? editId : Date.now(),
            date: date,
            moneyType: document.getElementById('moneyType').value,
            amount: amount,
            user: document.getElementById('user').value,
            item: item,
            client: document.getElementById('client').value,
            location: document.getElementById('location').value,
            payType: document.getElementById('payType').value,
            cardNo: document.getElementById('cardNo').value,
            detail: document.getElementById('detail').value,
            img: currentImgBase64
        };

        const url = isEditing ? (SERVER_URL + "?action=update") : SERVER_URL;

        showLoader(true);
        fetch(url, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(entry)
        })
        .then(() => {
            alert(isEditing ? "âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "âœ… ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            cancelEdit();
            loadData();
        })
        .catch(err => { alert("ì˜¤ë¥˜: " + err); showLoader(false); });
    }

    function editRow(id) {
        const item = db.find(row => row.ID == id);
        if(!item) return;

        isEditing = true;
        editId = id;

        document.getElementById('date').value = getSafeDate(item.ë‚ ì§œ).full;
        document.getElementById('moneyType').value = item.êµ¬ë¶„;
        document.getElementById('amount').value = item.ê¸ˆì•¡;
        document.getElementById('user').value = item.ì‚¬ìš©ì;
        document.getElementById('item').value = item.ì•„ì´í…œ;
        document.getElementById('detail').value = item.ìƒì„¸ë‚´ìš©;
        document.getElementById('client').value = item.ê³ ê°ì‚¬;
        document.getElementById('location').value = item.ì¥ì†Œ;
        document.getElementById('payType').value = item.í˜•íƒœ;
        document.getElementById('cardNo').value = item.ì¹´ë“œë²ˆí˜¸;

        document.getElementById('formTitle').innerText = "âœï¸ ë‚´ì—­ ìˆ˜ì • ì¤‘";
        document.getElementById('formTitle').style.color = "#e67e22";
        document.getElementById('btnSubmit').innerText = "ìˆ˜ì • ì™„ë£Œ";
        document.getElementById('btnSubmit').classList.add('editing');
        document.getElementById('btnCancel').style.display = 'block';
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        document.getElementById('btnCam').innerText = "ğŸ“· ì´¬ì˜ ë³€ê²½";
        document.getElementById('btnGal').innerText = "ğŸ“‚ ì•¨ë²” ë³€ê²½";

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        isEditing = false;
        editId = null;
        currentImgBase64 = null;
        
        const ids = ['amount', 'item', 'detail', 'user', 'client', 'location', 'cardNo'];
        ids.forEach(id => document.getElementById(id).value = '');
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('payType').value = 'ì¹´ë“œì˜ìˆ˜ì¦';
        
        clearImg();

        document.getElementById('formTitle').innerText = "ğŸ“ ì‹ ê·œ ë“±ë¡";
        document.getElementById('formTitle').style.color = "#2c3e50";
        document.getElementById('btnSubmit').innerText = "ë“±ë¡í•˜ê¸°";
        document.getElementById('btnSubmit').classList.remove('editing');
        document.getElementById('btnCancel').style.display = 'none';
        
        document.getElementById('btnCam').innerText = "ğŸ“· ë°”ë¡œ ì´¬ì˜";
        document.getElementById('btnGal').innerText = "ğŸ“‚ ì•¨ë²” ì„ íƒ";
    }

    function delEntry(id) {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        showLoader(true);
        fetch(SERVER_URL + "?action=delete&id=" + id)
        .then(res => res.json())
        .then(() => { alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadData(); })
        .catch(() => { alert("ì˜¤ë¥˜"); showLoader(false); });
    }

    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        db.forEach(item => {
            const val = parseInt(item.ê¸ˆì•¡).toLocaleString();
            const dateShort = getSafeDate(item.ë‚ ì§œ).short; 
            const typeClass = item.êµ¬ë¶„ === 'sales' ? 'col-sales' : 'col-exp';
            const clientName = item.ê³ ê°ì‚¬ || '-';
            
            let imgBtn = `<span style="color:#ccc">-</span>`;
            if(item.ì´ë¯¸ì§€URL && item.ì´ë¯¸ì§€URL.includes('drive.google.com')) {
                const idMatch = item.ì´ë¯¸ì§€URL.match(/id=([^&]+)/);
                if(idMatch) {
                    const thumb = `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1]}`;
                    imgBtn = `<a href="#" class="receipt-btn" onclick="openImageModal('${thumb}')">ë³´ê¸°</a>`;
                }
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dateShort}</td>
                <td>${item.ì•„ì´í…œ}<br><span style="font-size:11px; color:#888">${item.ì‚¬ìš©ì}</span></td>
                <td class="${typeClass}">${val}</td>
                <td style="font-size:12px;">${clientName}</td>
                <td>${imgBtn}</td>
                <td class="actions">
                    <button class="btn btn-edit" onclick="editRow('${item.ID}')">ìˆ˜ì •</button>
                    <button class="btn btn-del" onclick="delEntry('${item.ID}')">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // â˜…â˜…â˜… ì´ ì½”ë“œë¥¼ ìŠ¤í¬ë¦½íŠ¸(<script>) ë¶€ë¶„ì— ë³µì‚¬í•´ ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…

    function handleFile(input) {
        if(input.files && input.files[0]) {
            showLoader(true); // ë¡œë”© ì‹œì‘
            
            const file = input.files[0];
            const img = new Image();
            
            // 1. ë©”ëª¨ë¦¬ë¥¼ ì•„ë¼ê¸° ìœ„í•´ íŒŒì¼ ì£¼ì†Œë§Œ ë”°ì˜µë‹ˆë‹¤.
            img.src = URL.createObjectURL(file);
            
            img.onload = function() {
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                
                // 2. ê°€ë¡œ/ì„¸ë¡œ ì¤‘ ê¸´ ìª½ì„ 800pxë¡œ ì¤„ì…ë‹ˆë‹¤ (ì•ˆë“œë¡œì´ë“œ ìš©ëŸ‰ í­ë°œ ë°©ì§€)
                const maxDim = 800; 
                let w = img.width;
                let h = img.height;

                if (w > h) {
                    if (w > maxDim) { h *= maxDim / w; w = maxDim; }
                } else {
                    if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                }
                
                cvs.width = w; cvs.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                // 3. í™”ì§ˆì„ 60%ë¡œ ì••ì¶•í•´ì„œ ì €ì¥
                currentImgBase64 = cvs.toDataURL('image/jpeg', 0.6);
                
                // 4. í™”ë©´ ì²˜ë¦¬: ë²„íŠ¼ë“¤ì€ ìˆ¨ê¸°ê³ , ë¯¸ë¦¬ë³´ê¸° ì‚¬ì§„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                document.getElementById('preview-img').src = currentImgBase64;
                
                document.getElementById('btnArea').style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                document.getElementById('preview-area').style.display = 'block'; // ì‚¬ì§„ ë³´ì—¬ì£¼ê¸°
                
                // ë©”ëª¨ë¦¬ í•´ì œ
                URL.revokeObjectURL(img.src);
                showLoader(false);
            }
            
            img.onerror = function() {
                alert("ì‚¬ì§„ ì²˜ë¦¬ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                showLoader(false);
            }
        }
    }

    function clearImg() {
        // ì‚¬ì§„ ì‚­ì œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì´ˆê¸°í™”
        currentImgBase64 = null;
        document.getElementById('preview-area').style.display = 'none'; // ì‚¬ì§„ ìˆ¨ê¸°ê¸°
        document.getElementById('btnArea').style.display = 'block';     // ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
        
        // ì¹´ë©”ë¼, ì•¨ë²” ì…ë ¥ì°½ ëª¨ë‘ ë¹„ìš°ê¸°
        document.getElementById('cameraInput').value = '';
        document.getElementById('galleryInput').value = '';
    }
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function openImageModal(url) { 
        document.getElementById('imageModal').style.display = 'flex'; 
        document.getElementById('modalImg').src = url; 
    }
</script>

</body>
</html>


