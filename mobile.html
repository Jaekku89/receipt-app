<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">
    <title>ë§¤ì…ë§¤ì¶œ ì „ìš© ê´€ë¦¬ì•±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* í†µí•© ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜•) */
        :root { --primary: #2c3e50; --blue: #2980b9; --red: #c0392b; --orange: #d35400; --light: #f4f6f8; --border: #dfe6e9; --green: #27ae60; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 15px; background: var(--light); font-size: 14px; color: #333; -webkit-tap-highlight-color: transparent; }
        
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        .header h1 { font-size: 20px; margin: 0; color: var(--primary); }
        
        .btn { border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; padding: 8px 12px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-refresh { background: var(--green); color: white; }
        .btn-cancel-edit { background: #95a5a6; color: white; margin-left: 10px; display: none; }

        /* ì…ë ¥ í¼ */
        .input-section { background: #fafbfc; padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 25px; }
        .input-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 6px; font-size: 12px; color: #555; }
        .form-control { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        /* ë²„íŠ¼ ì˜ì—­ */
        .btn-submit { grid-column: span 4; background: var(--primary); color: white; padding: 14px; font-size: 16px; margin-top: 10px; }
        .btn-submit.editing { background: #e67e22; } /* ìˆ˜ì • ì¤‘ì¼ ë•Œ ì£¼í™©ìƒ‰ */

        /* ì¹´ë©”ë¼/íŒŒì¼ */
        .camera-wrapper { grid-column: span 4; display: flex; flex-direction: column; gap: 10px; }
        .btn-camera { background: #ecf0f1; color: var(--primary); border: 2px dashed #bdc3c7; padding: 12px; text-align: center; width: 100%; }
        .btn-camera.active { border-color: var(--green); color: var(--green); background: #e8f8f5; }
        #preview-area { display: none; text-align: center; background: #eaf2f8; padding: 10px; border-radius: 6px; }
        #preview-img { max-height: 200px; max-width: 100%; border-radius: 4px; }

        /* í…Œì´ë¸” */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8f9fa; font-weight: 600; color: #444; white-space: nowrap; }
        
        .col-fixed { color: var(--orange); font-weight: bold; background: #fffdf9; }
        .col-var { color: var(--red); font-weight: bold; background: #fff5f5; }
        .col-sales { color: var(--blue); font-weight: bold; background: #f0f9ff; }
        
        .receipt-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; }
        .btn-edit { background: #3498db; color: white; padding: 4px 8px; margin-right: 4px; font-size: 11px; }
        .btn-del { background: #e74c3c; color: white; padding: 4px 8px; font-size: 11px; }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .input-grid { grid-template-columns: 1fr; gap: 15px; }
            .btn-submit, .camera-wrapper { grid-column: span 1; }
            th, td { padding: 10px 5px; font-size: 12px; }
        }

        /* ë¡œë”© & ëª¨ë‹¬ */
        .loader-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; flex-direction: column; }
        .modal-content { max-width: 95%; max-height: 80%; object-fit: contain; }
        .close-modal { position: absolute; top: 30px; right: 20px; color: white; font-size: 35px; font-weight: bold; cursor: pointer; padding: 10px; }
    </style>
</head>
<body>

<div id="loader" class="loader-overlay"><div class="loader"></div><div id="loader-text">ì²˜ë¦¬ ì¤‘...</div></div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ë§¤ì…ë§¤ì¶œ ê´€ë¦¬</h1>
        <button class="btn btn-refresh" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="input-section">
        <h3 style="margin-top:0; font-size:16px; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between;">
            <span id="formTitle">ğŸ“ ì‹ ê·œ ë“±ë¡</span>
            <button class="btn btn-cancel-edit" id="btnCancelEdit" onclick="cancelEditMode()">ì·¨ì†Œ</button>
        </h3>
        <div class="input-grid">
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="date" class="form-control"></div>
            <div class="form-group"><label>êµ¬ë¶„</label><select id="moneyType" class="form-control"><option value="variable">ì§€ì¶œë§¤ì… (-)</option><option value="sales">ë§¤ì¶œ (+)</option><option value="fixed">ê³ ì •ë§¤ì… (-)</option></select></div>
            <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="tel" id="amount" placeholder="0" class="form-control"></div>
            <div class="form-group"><label>ì‚¬ìš©ì</label><input type="text" id="user" placeholder="ì´ë¦„" class="form-control"></div>
            
            <div class="form-group"><label>ì•„ì´í…œ</label><input type="text" id="item" placeholder="í’ˆëª©" class="form-control"></div>
            <div class="form-group"><label>ìƒì„¸ ë‚´ìš©</label><input type="text" id="detail" placeholder="ë‚´ìš©" class="form-control"></div>
            <div class="form-group"><label>ê³ ê°ì‚¬</label><input type="text" id="client" placeholder="ê±°ë˜ì²˜" class="form-control"></div>
            <div class="form-group"><label>ì¥ì†Œ</label><input type="text" id="location" placeholder="ì¥ì†Œ" class="form-control"></div>
            
            <div class="form-group"><label>í˜•íƒœ</label><select id="payType" class="form-control"><option value="ì¹´ë“œì˜ìˆ˜ì¦">ì¹´ë“œì˜ìˆ˜ì¦</option><option value="ê³„ì‚°ì„œë°œí–‰">ê³„ì‚°ì„œë°œí–‰</option><option value="ì†¡ê¸ˆ">ì†¡ê¸ˆ</option><option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option></select></div>
            <div class="form-group"><label>ì¹´ë“œë²ˆí˜¸</label><input type="text" id="cardNo" placeholder="ë²ˆí˜¸" class="form-control"></div>

            <div class="camera-wrapper">
                <input type="file" id="fileInput" style="display:none" accept="image/*" onchange="handleFileSelect(this)">
                <button class="btn btn-camera" id="btnCam" onclick="document.getElementById('fileInput').click()">ğŸ“· ì˜ìˆ˜ì¦ ì´¬ì˜ / íŒŒì¼ ì„ íƒ</button>
                <div id="preview-area">
                    <img id="preview-img" src="">
                    <button class="btn" onclick="clearPreview()" style="margin-top:5px; border:1px solid #ccc; background:white;">ì´ë¯¸ì§€ ì‚­ì œ</button>
                </div>
            </div>

            <button onclick="submitData()" id="btnSubmit" class="btn btn-submit">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>êµ¬ë¶„</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ë‚´ìš©</th>
                    <th>ì‚¬ìš©ì</th>
                    <th>ì˜ìˆ˜ì¦</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="imageModal" class="modal" onclick="this.style.display='none'">
    <div class="close-modal">&times;</div>
    <img class="modal-content" id="modalImg">
</div>

<script>
    // â˜…â˜…â˜… ì£¼ì†Œë¥¼ ê¼­ ë„£ì–´ì£¼ì„¸ìš” â˜…â˜…â˜…
    const SERVER_URL = "https://script.google.com/macros/s/AKfycbxAbo6PtrKdVUVY5Vy9hEtC7d5U51kYchvGesrq7OkxKe84JmQxeTESh84UITFFOI_x/exec"; 

    let db = [];
    let currentImgBase64 = null;
    let isEditing = false; // ìˆ˜ì • ëª¨ë“œì¸ì§€ ì²´í¬
    let editId = null; // ìˆ˜ì • ì¤‘ì¸ ë°ì´í„° ID

    window.onload = function() {
        document.getElementById('date').valueAsDate = new Date();
        loadData();
    };

    function loadData() {
        if(SERVER_URL.includes("ì—¬ê¸°ì—")) { alert("https://script.google.com/macros/s/AKfycbxAbo6PtrKdVUVY5Vy9hEtC7d5U51kYchvGesrq7OkxKe84JmQxeTESh84UITFFOI_x/exec"); return; }
        showLoader(true);
        fetch(SERVER_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            db = data;
            db.sort((a,b) => new Date(b.ë‚ ì§œ) - new Date(a.ë‚ ì§œ));
            renderTable();
            showLoader(false);
        })
        .catch(err => { alert("ë¡œë“œ ì‹¤íŒ¨: " + err); showLoader(false); });
    }

    // ë“±ë¡ ë˜ëŠ” ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
    function submitData() {
        const date = document.getElementById('date').value;
        const amount = document.getElementById('amount').value;
        const item = document.getElementById('item').value;

        if(!date || !amount || !item) { alert("ë‚ ì§œ, ê¸ˆì•¡, ì•„ì´í…œì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }

        const entry = {
            id: isEditing ? editId : Date.now(), // ìˆ˜ì •ì´ë©´ ê¸°ì¡´ ID ìœ ì§€
            date: date,
            moneyType: document.getElementById('moneyType').value,
            amount: amount,
            user: document.getElementById('user').value,
            item: item,
            client: document.getElementById('client').value,
            location: document.getElementById('location').value,
            payType: document.getElementById('payType').value,
            detail: document.getElementById('detail').value,
            cardNo: document.getElementById('cardNo').value,
            img: currentImgBase64 // ì´ë¯¸ì§€ ë³€ê²½ ì—†ìœ¼ë©´ null (ì„œë²„ê°€ ì•Œì•„ì„œ ì²˜ë¦¬)
        };

        // ìˆ˜ì • ëª¨ë“œë©´ action=update, ì•„ë‹ˆë©´ ê¸°ë³¸(append)
        const url = isEditing ? (SERVER_URL + "?action=update") : SERVER_URL;
        
        showLoader(true);
        fetch(url, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(entry)
        })
        .then(() => {
            alert(isEditing ? "âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "âœ… ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            cancelEditMode(); // í¼ ì´ˆê¸°í™”
            loadData();
        })
        .catch(err => { alert("ì˜¤ë¥˜ ë°œìƒ: " + err); showLoader(false); });
    }

    // ìˆ˜ì • ë²„íŠ¼ ëˆŒë €ì„ ë•Œ (í¼ì— ë°ì´í„° ì±„ìš°ê¸°)
    function editRow(id) {
        const item = db.find(row => row.ID == id); // IDëŠ” ìˆ«ì/ë¬¸ì ì£¼ì˜
        if(!item) return;

        isEditing = true;
        editId = id;

        // í¼ ì±„ìš°ê¸°
        document.getElementById('date').value = item.ë‚ ì§œ.substring(0,10);
        document.getElementById('moneyType').value = item.êµ¬ë¶„;
        document.getElementById('amount').value = item.ê¸ˆì•¡;
        document.getElementById('user').value = item.ì‚¬ìš©ì;
        document.getElementById('item').value = item.ì•„ì´í…œ;
        document.getElementById('client').value = item.ê³ ê°ì‚¬;
        document.getElementById('location').value = item.ì¥ì†Œ;
        document.getElementById('payType').value = item.í˜•íƒœ;
        document.getElementById('detail').value = item.ìƒì„¸ë‚´ìš©;
        document.getElementById('cardNo').value = item.ì¹´ë“œë²ˆí˜¸;

        // UI ë³€ê²½
        document.getElementById('formTitle').innerText = "âœï¸ ë‚´ì—­ ìˆ˜ì • ì¤‘...";
        document.getElementById('btnSubmit').innerText = "ìˆ˜ì • ë‚´ìš© ì €ì¥";
        document.getElementById('btnSubmit').classList.add('editing');
        document.getElementById('btnCancelEdit').style.display = 'block';
        document.getElementById('btnCam').innerText = "ğŸ“· ì‚¬ì§„ ë³€ê²½ (ì„ íƒì‚¬í•­)";
        
        // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ (ì…ë ¥ì°½ìœ¼ë¡œ)
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ìˆ˜ì • ì·¨ì†Œ / ì´ˆê¸°í™”
    function cancelEditMode() {
        isEditing = false;
        editId = null;
        currentImgBase64 = null;
        
        document.getElementById('amount').value = '';
        document.getElementById('item').value = '';
        document.getElementById('detail').value = '';
        document.getElementById('user').value = '';
        document.getElementById('client').value = '';
        // ë‚ ì§œëŠ” ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¦¬ì…‹
        document.getElementById('date').valueAsDate = new Date();

        clearPreview();

        // UI ë³µêµ¬
        document.getElementById('formTitle').innerText = "ğŸ“ ì‹ ê·œ ë“±ë¡";
        document.getElementById('btnSubmit').innerText = "ë“±ë¡í•˜ê¸°";
        document.getElementById('btnSubmit').classList.remove('editing');
        document.getElementById('btnCancelEdit').style.display = 'none';
    }

    function delEntry(id) {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        showLoader(true);
        fetch(SERVER_URL + "?action=delete&id=" + id)
        .then(res => res.json())
        .then(data => {
            if(data.result==="success") { alert("ì‚­ì œ ì™„ë£Œ"); loadData(); }
            else { alert("ì‚­ì œ ì‹¤íŒ¨"); showLoader(false); }
        })
        .catch(err => { alert("ì˜¤ë¥˜"); showLoader(false); });
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        db.forEach(item => {
            const val = parseInt(item.ê¸ˆì•¡)||0;
            const tr = document.createElement('tr');
            
            // ë‚ ì§œ (YYYY-MM-DD)
            let dShort = item.ë‚ ì§œ ? item.ë‚ ì§œ.toString().substring(0,10) : '-';
            
            // ì´ë¯¸ì§€ ì¸ë„¤ì¼
            let imgBtn = `<span style="color:#ccc">-</span>`;
            if(item.ì´ë¯¸ì§€URL && item.ì´ë¯¸ì§€URL.includes('drive.google.com')) {
                const idMatch = item.ì´ë¯¸ì§€URL.match(/id=([^&]+)/);
                if(idMatch) {
                    let thumb = `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1]}`;
                    imgBtn = `<img src="${thumb}" class="receipt-thumb" onclick="openImageModal('${thumb}')">`;
                }
            }

            // ìŠ¤íƒ€ì¼
            let moneyClass = item.êµ¬ë¶„==='sales' ? 'col-sales' : (item.êµ¬ë¶„==='fixed' ? 'col-fixed' : 'col-var');

            tr.innerHTML = `
                <td>${dShort}</td>
                <td>${item.êµ¬ë¶„==='sales'?'ë§¤ì¶œ':(item.êµ¬ë¶„==='fixed'?'ê³ ì •':'ì§€ì¶œ')}</td>
                <td class="${moneyClass}">${val.toLocaleString()}</td>
                <td style="text-align:left">${item.ì•„ì´í…œ}<br><small style="color:#888">${item.ìƒì„¸ë‚´ìš©||''}</small></td>
                <td>${item.ì‚¬ìš©ì||'-'}</td>
                <td>${imgBtn}</td>
                <td>
                    <button class="btn btn-edit" onclick="editRow('${item.ID}')">ìˆ˜ì •</button>
                    <button class="btn btn-del" onclick="delEntry('${item.ID}')">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // íŒŒì¼ ì²˜ë¦¬
    function handleFileSelect(input) {
        if(input.files[0]) {
            showLoader(true);
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    let w = img.width, h = img.height;
                    if(w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img,0,0,w,h);
                    currentImgBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('preview-img').src = currentImgBase64;
                    document.getElementById('preview-area').style.display = 'block';
                    document.getElementById('btnCam').innerText = "âœ… ì‚¬ì§„ ì¤€ë¹„ë¨";
                    document.getElementById('btnCam').classList.add('active');
                    showLoader(false);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearPreview() {
        currentImgBase64 = null;
        document.getElementById('preview-area').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('btnCam').innerText = "ğŸ“· ì˜ìˆ˜ì¦ ì´¬ì˜ / íŒŒì¼ ì„ íƒ";
        document.getElementById('btnCam').classList.remove('active');
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function openImageModal(url) { document.getElementById('imageModal').style.display = 'flex'; document.getElementById('modalImg').src = url; }
</script>

</body>
</html>

