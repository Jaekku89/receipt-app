<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">
    
    <title>ê²½ë¹„ì§€ì¶œê´€ë¦¬</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f4f6; margin: 0; padding: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* í—¤ë” */
        .app-header { background-color: #2c3e50; color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; padding-top: env(safe-area-inset-top); }
        .app-title { font-size: 18px; font-weight: bold; margin: 0; }
        .btn-refresh { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* ì…ë ¥ ì¹´ë“œ */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; font-weight: 600; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #e1e4e8; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; appearance: none; }
        .form-control:focus { outline: none; border-color: #2c3e50; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* ì¹´ë©”ë¼/ë“±ë¡ ë²„íŠ¼ */
        .btn-camera { width: 100%; background-color: #ecf0f1; color: #2c3e50; padding: 15px; border: 2px dashed #bdc3c7; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-camera.active { background-color: #e8f8f5; border-color: #27ae60; color: #27ae60; }
        .btn-submit { width: 100%; background-color: #2c3e50; color: white; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 6px rgba(44, 62, 80, 0.2); }
        .btn-submit:active { transform: scale(0.98); }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .list-header { padding: 0 20px; font-size: 14px; font-weight: bold; color: #555; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .transaction-item { background: white; padding: 15px; margin: 0 15px 10px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .t-left { display: flex; flex-direction: column; gap: 2px; }
        .t-date { font-size: 11px; color: #999; }
        .t-title { font-size: 15px; font-weight: bold; color: #333; }
        .t-sub { font-size: 12px; color: #666; }
        .t-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px;}
        .t-amount { font-size: 15px; font-weight: bold; color: #2c3e50; }
        .t-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; display: inline-block; }
        .btn-view-img { background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-top: 2px;}
        
        .type-exp { color: #c0392b; background: #fadbd8; }
        .type-sales { color: #2980b9; background: #d4e6f1; }

        /* ë¡œë”©/ëª¨ë‹¬ */
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #preview-area { display: none; margin-top: 10px; position: relative; }
        #preview-img { width: 100%; border-radius: 8px; max-height: 200px; object-fit: cover; }
        .btn-remove-img { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 16px; line-height: 25px; text-align: center; cursor: pointer; }

        /* ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; flex-direction: column; }
        .modal-content { max-width: 95%; max-height: 80%; object-fit: contain; }
        .close-modal { position: absolute; top: 40px; right: 20px; color: white; font-size: 35px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader" class="loader-overlay">
    <div class="spinner"></div>
    <div id="loader-text">ì²˜ë¦¬ì¤‘...</div>
</div>

<div class="app-header">
    <h1 class="app-title">ğŸ§¾ ê°„í¸ ê²½ë¹„ ë“±ë¡</h1>
    <button class="btn-refresh" onclick="loadData()">â†»</button>
</div>

<div class="card">
    <div class="row">
        <div class="col input-group">
            <span class="input-label">ë‚ ì§œ</span>
            <input type="date" id="date" class="form-control">
        </div>
        <div class="col input-group">
            <span class="input-label">êµ¬ë¶„</span>
            <select id="moneyType" class="form-control">
                <option value="variable">ì§€ì¶œ</option>
                <option value="sales">ë§¤ì¶œ</option>
                <option value="fixed">ê³ ì •ë¹„</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col input-group">
            <span class="input-label">ê¸ˆì•¡ (ì›)</span>
            <input type="tel" id="amount" class="form-control" placeholder="0">
        </div>
        <div class="col input-group">
            <span class="input-label">ì‚¬ìš©ì</span>
            <input type="text" id="user" class="form-control" placeholder="ì´ë¦„">
        </div>
    </div>

    <div class="input-group">
        <span class="input-label">ì‚¬ìš© ë‚´ì—­ (ì•„ì´í…œ)</span>
        <input type="text" id="item" class="form-control" placeholder="ì˜ˆ: ì ì‹¬ì‹ì‚¬, ìì¬êµ¬ì…">
    </div>

    <div class="input-group">
        <span class="input-label">ìƒì„¸ ì„¤ëª… (ì„ íƒ)</span>
        <input type="text" id="detail" class="form-control" placeholder="ì¶”ê°€ ì„¤ëª…">
    </div>

    <div style="display:none">
        <input type="text" id="client" value="-">
        <input type="text" id="location" value="-">
        <input type="text" id="payType" value="ì¹´ë“œ">
        <input type="text" id="cardNo" value="-">
    </div>

    <div class="input-group">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this)">
        <button class="btn-camera" onclick="document.getElementById('cameraInput').click()" id="btnCam">
            ğŸ“· ì˜ìˆ˜ì¦ ì´¬ì˜
        </button>
        <div id="preview-area">
            <img id="preview-img" src="">
            <div class="btn-remove-img" onclick="clearImg()">Ã—</div>
        </div>
    </div>

    <button class="btn-submit" onclick="uploadData()">ë“±ë¡í•˜ê¸°</button>
</div>

<div class="list-header">
    <span>ìµœê·¼ ë‚´ì—­ (5ê±´)</span>
</div>
<div id="list-container"></div>

<div id="imgModal" class="modal" onclick="this.style.display='none'">
    <div class="close-modal">&times;</div>
    <img class="modal-content" id="modalImg">
</div>

<script>
    // â˜…â˜…â˜… ì‚¬ì¥ë‹˜ì˜ êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œ (ë³€ê²½ ì—†ìŒ) â˜…â˜…â˜…
    const SERVER_URL = "https://script.google.com/macros/s/AKfycbw2UcOYPW05IpmA2nYYTkhg6sXMwihD9OPA-sevP1WDtWZLoBB1l78IC82vff68voMKqg/exec";

    let currentImgBase64 = null;

    window.onload = function() {
        document.getElementById('date').valueAsDate = new Date();
        loadData();
    };

    function loadData() {
        const btn = document.querySelector('.btn-refresh');
        btn.style.transform = "rotate(360deg)";
        btn.style.transition = "1s";

        fetch(SERVER_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            // ë‚ ì§œ ì •ë ¬
            data.sort((a,b) => new Date(b.ë‚ ì§œ) - new Date(a.ë‚ ì§œ));
            renderList(data.slice(0, 5));
            setTimeout(() => { btn.style.transform = "rotate(0deg)"; btn.style.transition = "0s"; }, 1000);
        })
        .catch(err => console.error(err));
    }

    function renderList(data) {
        const list = document.getElementById('list-container');
        list.innerHTML = '';

        data.forEach(item => {
            const isSales = item.êµ¬ë¶„ === 'sales';
            const amountStr = parseInt(item.ê¸ˆì•¡).toLocaleString();
            const typeClass = isSales ? 'type-sales' : 'type-exp';
            const typeText = isSales ? 'ë§¤ì¶œ' : 'ì§€ì¶œ';
            
            // â˜…[ìˆ˜ì • 1] ë‚ ì§œ í¬ë§· (YYYY-MM-DD -> MM-DD) ë° null ì²´í¬
            let dateShort = item.ë‚ ì§œ ? item.ë‚ ì§œ.toString().substring(5, 10) : '-';

            // â˜…[ìˆ˜ì • 2] ì´ë¯¸ì§€ URL ì¸ë„¤ì¼ ë³€í™˜ (ì•ˆ ê¹¨ì§€ê²Œ)
            let imgBtn = '';
            let safeImgUrl = item.ì´ë¯¸ì§€URL;
            
            if (safeImgUrl && safeImgUrl.includes("drive.google.com")) {
                const idMatch = safeImgUrl.match(/id=([^&]+)/);
                if(idMatch) {
                    // ê³ í™”ì§ˆ ì¸ë„¤ì¼ ì£¼ì†Œë¡œ ë³€ê²½
                    safeImgUrl = `https://drive.google.com/thumbnail?sz=w1000&id=${idMatch[1]}`;
                    imgBtn = `<button class="btn-view-img" onclick="showImg('${safeImgUrl}')">ì‚¬ì§„</button>`;
                }
            }

            const safe = (txt) => txt || '';

            const div = document.createElement('div');
            div.className = 'transaction-item';
            div.innerHTML = `
                <div class="t-left">
                    <span class="t-title">${safe(item.ì•„ì´í…œ)}</span>
                    <span class="t-sub">${safe(item.ì‚¬ìš©ì)} Â· ${safe(item.ìƒì„¸ë‚´ìš©)}</span>
                    <span class="t-date">${dateShort}</span>
                </div>
                <div class="t-right">
                    <div class="t-amount">${isSales ? '+' : '-'}${amountStr}</div>
                    <span class="t-type ${typeClass}">${typeText}</span>
                    ${imgBtn}
                </div>
            `;
            list.appendChild(div);
        });
    }

    function uploadData() {
        const amt = document.getElementById('amount').value;
        const user = document.getElementById('user').value;
        const item = document.getElementById('item').value;

        if(!amt || !user || !item) {
            alert("ê¸ˆì•¡, ì‚¬ìš©ì, ë‚´ì—­ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            return;
        }

        const data = {
            id: Date.now(),
            date: document.getElementById('date').value,
            moneyType: document.getElementById('moneyType').value,
            amount: amt,
            user: user,
            item: item,
            detail: document.getElementById('detail').value,
            client: "-", 
            location: "-",
            payType: "ì¹´ë“œ",
            cardNo: "-",
            img: currentImgBase64 || ""
        };

        showLoader(true);

        fetch(SERVER_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(() => {
            showLoader(false);
            alert("âœ… ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            clearForm();
            loadData();
        })
        .catch(err => {
            showLoader(false);
            alert("ì €ì¥ ì‹¤íŒ¨: " + err);
        });
    }

    function handleFile(input) {
        if(input.files[0]) {
            showLoader(true);
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; 
                    let w = img.width;
                    let h = img.height;
                    
                    if(w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    currentImgBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('preview-img').src = currentImgBase64;
                    document.getElementById('preview-area').style.display = 'block';
                    document.getElementById('btnCam').classList.add('active');
                    document.getElementById('btnCam').innerText = "ì‚¬ì§„ ë³€ê²½í•˜ê¸°";
                    showLoader(false);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearImg() {
        currentImgBase64 = null;
        document.getElementById('preview-area').style.display = 'none';
        document.getElementById('cameraInput').value = '';
        document.getElementById('btnCam').classList.remove('active');
        document.getElementById('btnCam').innerText = "ğŸ“· ì˜ìˆ˜ì¦ ì´¬ì˜";
    }

    function clearForm() {
        document.getElementById('amount').value = '';
        document.getElementById('item').value = '';
        document.getElementById('detail').value = '';
        clearImg();
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function showImg(url) {
        // ëª¨ë‹¬ì—ì„œ ë³´ì—¬ì¤„ ë•ŒëŠ” ì›ë³¸ì— ê°€ê¹ê²Œ ë³´ì´ë„ë¡
        document.getElementById('modalImg').src = url;
        document.getElementById('imgModal').style.display = 'flex';
    }
</script>

</body>
</html>